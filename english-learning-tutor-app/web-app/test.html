<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web App Test</title>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .test-section { border: 1px solid #ddd; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .test-result { padding: 10px; margin: 5px 0; border-radius: 3px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        button { background: #007bff; color: white; border: none; padding: 10px 15px; margin: 5px; border-radius: 3px; cursor: pointer; }
        .log { background: #f8f9fa; border: 1px solid #ddd; padding: 10px; height: 300px; overflow-y: auto; font-family: monospace; }
    </style>
</head>
<body>
    <h1>🧪 English Learning App - Web Test Suite</h1>
    
    <div class="test-section">
        <h3>연결 테스트</h3>
        <button onclick="testConnection()">서버 연결 테스트</button>
        <div id="connectionResult"></div>
    </div>
    
    <div class="test-section">
        <h3>API 테스트</h3>
        <button onclick="testHealthAPI()">Health Check</button>
        <button onclick="testAuthAPI()">인증 API</button>
        <div id="apiResult"></div>
    </div>
    
    <div class="test-section">
        <h3>Socket.io 테스트</h3>
        <button onclick="testSocket()">Socket 연결</button>
        <button onclick="testChat()">채팅 테스트</button>
        <div id="socketResult"></div>
    </div>
    
    <div class="test-section">
        <h3>실시간 로그</h3>
        <div id="testLog" class="log"></div>
        <button onclick="clearLog()">로그 지우기</button>
    </div>

    <script>
        let socket = null;
        
        function log(message, type = 'info') {
            const logDiv = document.getElementById('testLog');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : '';
            logDiv.innerHTML += `<div class="test-result ${className}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function clearLog() {
            document.getElementById('testLog').innerHTML = '';
        }
        
        async function testConnection() {
            log('서버 연결 테스트 시작...');
            try {
                const response = await fetch('http://localhost:3000/health');
                if (response.ok) {
                    const data = await response.json();
                    log(`✅ 서버 연결 성공: ${data.status}`, 'success');
                    document.getElementById('connectionResult').innerHTML = '<div class="success">✅ 서버 연결 성공</div>';
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                log(`❌ 서버 연결 실패: ${error.message}`, 'error');
                document.getElementById('connectionResult').innerHTML = '<div class="error">❌ 서버 연결 실패</div>';
            }
        }
        
        async function testHealthAPI() {
            log('Health API 테스트 시작...');
            try {
                const response = await fetch('http://localhost:3000/health');
                const data = await response.json();
                log(`✅ Health API 응답: ${JSON.stringify(data)}`, 'success');
                document.getElementById('apiResult').innerHTML = '<div class="success">✅ Health API 정상</div>';
            } catch (error) {
                log(`❌ Health API 오류: ${error.message}`, 'error');
                document.getElementById('apiResult').innerHTML = '<div class="error">❌ Health API 오류</div>';
            }
        }
        
        async function testAuthAPI() {
            log('Auth API 테스트 시작...');
            try {
                const response = await fetch('http://localhost:3000/api/auth/test', {
                    method: 'GET'
                });
                log(`Auth API 응답 상태: ${response.status}`);
                if (response.ok) {
                    log('✅ Auth API 엔드포인트 접근 가능', 'success');
                } else {
                    log(`Auth API 상태: ${response.status} (정상 - 인증 필요)`, 'success');
                }
            } catch (error) {
                log(`❌ Auth API 테스트 실패: ${error.message}`, 'error');
            }
        }
        
        function testSocket() {
            log('Socket.io 연결 테스트 시작...');
            
            socket = io('http://localhost:3000', {
                transports: ['websocket']
            });
            
            socket.on('connect', () => {
                log('✅ Socket.io 연결 성공', 'success');
                document.getElementById('socketResult').innerHTML = '<div class="success">✅ Socket.io 연결 성공</div>';
            });
            
            socket.on('disconnect', () => {
                log('🔌 Socket.io 연결 끊어짐');
            });
            
            socket.on('error', (error) => {
                log(`❌ Socket.io 오류: ${error}`, 'error');
                document.getElementById('socketResult').innerHTML = '<div class="error">❌ Socket.io 연결 실패</div>';
            });
        }
        
        function testChat() {
            if (!socket || !socket.connected) {
                log('❌ Socket이 연결되지 않았습니다. 먼저 Socket 테스트를 실행하세요.', 'error');
                return;
            }
            
            log('채팅 기능 테스트 시작...');
            
            // 테스트 사용자로 인증
            socket.emit('authenticate', { 
                userId: 'test-user-' + Date.now() 
            });
            
            // 세션 참여
            const sessionId = 'test-session-' + Date.now();
            socket.emit('join_session', {
                sessionId: sessionId,
                userId: 'test-user',
                situationId: 'cafe'
            });
            
            log(`📝 세션 참여 요청: ${sessionId}`);
            
            // AI 응답 리스너
            socket.on('ai_response', (data) => {
                log(`🤖 AI 응답 수신: ${data.response}`, 'success');
            });
            
            socket.on('session_started', (data) => {
                log('✅ 세션 시작됨', 'success');
                
                // 테스트 메시지 전송
                setTimeout(() => {
                    socket.emit('send_message', {
                        sessionId: sessionId,
                        message: 'Hello, I would like to order a coffee please.',
                        timestamp: new Date().toISOString()
                    });
                    log('📤 테스트 메시지 전송: "Hello, I would like to order a coffee please."');
                }, 1000);
            });
        }
        
        // 페이지 로드 시 자동 테스트
        document.addEventListener('DOMContentLoaded', () => {
            log('🚀 웹 앱 테스트 시작');
            testConnection();
        });
    </script>
</body>
</html>