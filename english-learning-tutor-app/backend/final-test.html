<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Final Socket.io Test</title>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <style>
        body { font-family: Arial; padding: 20px; }
        button { padding: 10px 20px; margin: 5px; font-size: 16px; cursor: pointer; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .success { color: green; font-weight: bold; }
        .error { color: red; }
        .log { background: #f4f4f4; padding: 15px; margin: 10px 0; border-radius: 5px; max-height: 400px; overflow-y: auto; }
        .message { padding: 5px; margin: 2px 0; border-left: 3px solid #007bff; background: white; }
    </style>
</head>
<body>
    <h1>🎓 영어 학습 앱 - 최종 테스트</h1>
    
    <div>
        <h3>현재 상태: <span id="status">준비됨</span></h3>
    </div>
    
    <div>
        <button id="connectBtn" onclick="connectToServer()">1. 서버 연결</button>
        <button id="authBtn" onclick="authenticate()" disabled>2. 사용자 인증</button>
        <button id="joinBtn" onclick="joinSession()" disabled>3. 세션 참여</button>
        <button id="msgBtn" onclick="sendMessage()" disabled>4. 메시지 전송</button>
        <button id="voiceBtn" onclick="sendVoice()" disabled>5. 음성 전송</button>
        <button onclick="clearLog()">로그 지우기</button>
    </div>
    
    <div class="log" id="log"></div>
    
    <script>
        let socket = null;
        let currentSessionId = null;  // 현재 세션 ID 저장
        
        function log(msg, type = '') {
            const logDiv = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : '';
            logDiv.innerHTML += `<div class="message ${className}">[${time}] ${msg}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(msg);
        }
        
        function updateStatus(text, isSuccess = false) {
            const status = document.getElementById('status');
            status.innerText = text;
            status.className = isSuccess ? 'success' : '';
        }
        
        function connectToServer() {
            log('서버 연결 시도 중...');
            
            socket = io('http://localhost:3000', {
                transports: ['polling', 'websocket']
            });
            
            socket.on('connect', () => {
                log('✅ 서버 연결 성공! Socket ID: ' + socket.id, 'success');
                updateStatus('연결됨', true);
                document.getElementById('connectBtn').disabled = true;
                document.getElementById('authBtn').disabled = false;
            });
            
            socket.on('connect_error', (error) => {
                log('❌ 연결 오류: ' + error.message, 'error');
                updateStatus('연결 실패');
            });
            
            socket.on('disconnect', (reason) => {
                log('연결 끊김: ' + reason);
                updateStatus('연결 끊김');
            });
            
            // 이벤트 리스너 등록
            socket.on('authenticated', (data) => {
                log('✅ 인증 성공: ' + JSON.stringify(data), 'success');
                document.getElementById('authBtn').disabled = true;
                document.getElementById('joinBtn').disabled = false;
            });
            
            socket.on('auth-error', (error) => {
                log('❌ 인증 실패: ' + JSON.stringify(error), 'error');
            });
            
            socket.on('conversation-joined', (data) => {
                log('✅ 세션 참여 성공: ' + JSON.stringify(data), 'success');
                currentSessionId = data.sessionId;  // 세션 ID 저장
                log('현재 세션 ID: ' + currentSessionId);
                document.getElementById('joinBtn').disabled = true;
                document.getElementById('msgBtn').disabled = false;
                document.getElementById('voiceBtn').disabled = false;
            });
            
            socket.on('message-sent', (data) => {
                log('✅ 메시지 전송 완료: ' + data.message.content, 'success');
            });
            
            socket.on('voice-processed', (data) => {
                log('✅ 음성 처리 완료: ' + data.transcription, 'success');
                if (data.analysis) {
                    log('발음 점수: ' + data.analysis.pronunciationScore + '%');
                }
            });
            
            socket.on('error', (error) => {
                log('❌ 오류: ' + JSON.stringify(error), 'error');
            });
        }
        
        function authenticate() {
            if (!socket) return;
            log('사용자 인증 중...');
            socket.emit('authenticate', { userId: 'test-user-' + Date.now() });
        }
        
        function joinSession() {
            if (!socket) return;
            log('세션 참여 중...');
            currentSessionId = 'test-session-' + Date.now();  // 세션 ID 생성 및 저장
            socket.emit('join-conversation', {
                sessionId: currentSessionId,
                situationId: 'daegu_taxi'
            });
        }
        
        function sendMessage() {
            if (!socket || !currentSessionId) {
                log('❌ 세션에 참여하지 않았습니다', 'error');
                return;
            }
            const msg = 'Hello, could you take me to Suseong Lake?';
            log('메시지 전송: ' + msg);
            socket.emit('send-message', {
                message: msg,
                sessionId: currentSessionId  // 저장된 세션 ID 사용
            });
        }
        
        function sendVoice() {
            if (!socket || !currentSessionId) {
                log('❌ 세션에 참여하지 않았습니다', 'error');
                return;
            }
            log('Mock 음성 데이터 전송 중...');
            const mockAudio = 'data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQAAAAA=';
            socket.emit('send-voice', {
                audioData: mockAudio,
                duration: 2000,
                sessionId: currentSessionId  // 저장된 세션 ID 사용
            });
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }
        
        // 페이지 로드 시
        window.onload = function() {
            log('페이지 준비 완료. "서버 연결" 버튼을 클릭하세요.');
        }
    </script>
</body>
</html>