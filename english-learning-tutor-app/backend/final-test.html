<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Final Socket.io Test</title>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <style>
        body { font-family: Arial; padding: 20px; }
        button { padding: 10px 20px; margin: 5px; font-size: 16px; cursor: pointer; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .success { color: green; font-weight: bold; }
        .error { color: red; }
        .log { background: #f4f4f4; padding: 15px; margin: 10px 0; border-radius: 5px; max-height: 400px; overflow-y: auto; }
        .message { padding: 5px; margin: 2px 0; border-left: 3px solid #007bff; background: white; }
    </style>
</head>
<body>
    <h1>ğŸ“ ì˜ì–´ í•™ìŠµ ì•± - ìµœì¢… í…ŒìŠ¤íŠ¸</h1>
    
    <div>
        <h3>í˜„ì¬ ìƒíƒœ: <span id="status">ì¤€ë¹„ë¨</span></h3>
    </div>
    
    <div>
        <button id="connectBtn" onclick="connectToServer()">1. ì„œë²„ ì—°ê²°</button>
        <button id="authBtn" onclick="authenticate()" disabled>2. ì‚¬ìš©ì ì¸ì¦</button>
        <button id="joinBtn" onclick="joinSession()" disabled>3. ì„¸ì…˜ ì°¸ì—¬</button>
        <button id="msgBtn" onclick="sendMessage()" disabled>4. ë©”ì‹œì§€ ì „ì†¡</button>
        <button id="voiceBtn" onclick="sendVoice()" disabled>5. ìŒì„± ì „ì†¡</button>
        <button onclick="clearLog()">ë¡œê·¸ ì§€ìš°ê¸°</button>
    </div>
    
    <div class="log" id="log"></div>
    
    <script>
        let socket = null;
        let currentSessionId = null;  // í˜„ì¬ ì„¸ì…˜ ID ì €ì¥
        
        function log(msg, type = '') {
            const logDiv = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : '';
            logDiv.innerHTML += `<div class="message ${className}">[${time}] ${msg}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(msg);
        }
        
        function updateStatus(text, isSuccess = false) {
            const status = document.getElementById('status');
            status.innerText = text;
            status.className = isSuccess ? 'success' : '';
        }
        
        function connectToServer() {
            log('ì„œë²„ ì—°ê²° ì‹œë„ ì¤‘...');
            
            socket = io('http://localhost:3000', {
                transports: ['polling', 'websocket']
            });
            
            socket.on('connect', () => {
                log('âœ… ì„œë²„ ì—°ê²° ì„±ê³µ! Socket ID: ' + socket.id, 'success');
                updateStatus('ì—°ê²°ë¨', true);
                document.getElementById('connectBtn').disabled = true;
                document.getElementById('authBtn').disabled = false;
            });
            
            socket.on('connect_error', (error) => {
                log('âŒ ì—°ê²° ì˜¤ë¥˜: ' + error.message, 'error');
                updateStatus('ì—°ê²° ì‹¤íŒ¨');
            });
            
            socket.on('disconnect', (reason) => {
                log('ì—°ê²° ëŠê¹€: ' + reason);
                updateStatus('ì—°ê²° ëŠê¹€');
            });
            
            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
            socket.on('authenticated', (data) => {
                log('âœ… ì¸ì¦ ì„±ê³µ: ' + JSON.stringify(data), 'success');
                document.getElementById('authBtn').disabled = true;
                document.getElementById('joinBtn').disabled = false;
            });
            
            socket.on('auth-error', (error) => {
                log('âŒ ì¸ì¦ ì‹¤íŒ¨: ' + JSON.stringify(error), 'error');
            });
            
            socket.on('conversation-joined', (data) => {
                log('âœ… ì„¸ì…˜ ì°¸ì—¬ ì„±ê³µ: ' + JSON.stringify(data), 'success');
                currentSessionId = data.sessionId;  // ì„¸ì…˜ ID ì €ì¥
                log('í˜„ì¬ ì„¸ì…˜ ID: ' + currentSessionId);
                document.getElementById('joinBtn').disabled = true;
                document.getElementById('msgBtn').disabled = false;
                document.getElementById('voiceBtn').disabled = false;
            });
            
            socket.on('message-sent', (data) => {
                log('âœ… ë©”ì‹œì§€ ì „ì†¡ ì™„ë£Œ: ' + data.message.content, 'success');
            });
            
            socket.on('voice-processed', (data) => {
                log('âœ… ìŒì„± ì²˜ë¦¬ ì™„ë£Œ: ' + data.transcription, 'success');
                if (data.analysis) {
                    log('ë°œìŒ ì ìˆ˜: ' + data.analysis.pronunciationScore + '%');
                }
            });
            
            socket.on('error', (error) => {
                log('âŒ ì˜¤ë¥˜: ' + JSON.stringify(error), 'error');
            });
        }
        
        function authenticate() {
            if (!socket) return;
            log('ì‚¬ìš©ì ì¸ì¦ ì¤‘...');
            socket.emit('authenticate', { userId: 'test-user-' + Date.now() });
        }
        
        function joinSession() {
            if (!socket) return;
            log('ì„¸ì…˜ ì°¸ì—¬ ì¤‘...');
            currentSessionId = 'test-session-' + Date.now();  // ì„¸ì…˜ ID ìƒì„± ë° ì €ì¥
            socket.emit('join-conversation', {
                sessionId: currentSessionId,
                situationId: 'daegu_taxi'
            });
        }
        
        function sendMessage() {
            if (!socket || !currentSessionId) {
                log('âŒ ì„¸ì…˜ì— ì°¸ì—¬í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤', 'error');
                return;
            }
            const msg = 'Hello, could you take me to Suseong Lake?';
            log('ë©”ì‹œì§€ ì „ì†¡: ' + msg);
            socket.emit('send-message', {
                message: msg,
                sessionId: currentSessionId  // ì €ì¥ëœ ì„¸ì…˜ ID ì‚¬ìš©
            });
        }
        
        function sendVoice() {
            if (!socket || !currentSessionId) {
                log('âŒ ì„¸ì…˜ì— ì°¸ì—¬í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤', 'error');
                return;
            }
            log('Mock ìŒì„± ë°ì´í„° ì „ì†¡ ì¤‘...');
            const mockAudio = 'data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQAAAAA=';
            socket.emit('send-voice', {
                audioData: mockAudio,
                duration: 2000,
                sessionId: currentSessionId  // ì €ì¥ëœ ì„¸ì…˜ ID ì‚¬ìš©
            });
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ
        window.onload = function() {
            log('í˜ì´ì§€ ì¤€ë¹„ ì™„ë£Œ. "ì„œë²„ ì—°ê²°" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.');
        }
    </script>
</body>
</html>