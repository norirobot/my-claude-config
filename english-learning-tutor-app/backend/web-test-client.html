<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì˜ì–´ í•™ìŠµ ì•± - ì›¹ í…ŒìŠ¤íŠ¸ í´ë¼ì´ì–¸íŠ¸</title>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .section { border: 1px solid #ddd; margin: 10px 0; padding: 15px; border-radius: 5px; }
        .section h3 { margin-top: 0; color: #333; }
        .status { padding: 5px 10px; border-radius: 3px; font-weight: bold; }
        .connected { background: #d4edda; color: #155724; }
        .disconnected { background: #f8d7da; color: #721c24; }
        .message { margin: 5px 0; padding: 8px; background: #f8f9fa; border-left: 4px solid #007bff; }
        .error { border-left-color: #dc3545; background: #f8d7da; }
        .success { border-left-color: #28a745; background: #d4edda; }
        button { background: #007bff; color: white; border: none; padding: 10px 15px; margin: 5px; border-radius: 3px; cursor: pointer; }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        input, textarea { width: 100%; padding: 8px; margin: 5px 0; border: 1px solid #ddd; border-radius: 3px; }
        .log { background: #f8f9fa; border: 1px solid #ddd; padding: 10px; height: 200px; overflow-y: auto; font-family: monospace; font-size: 12px; }
    </style>
</head>
<body>
    <h1>ğŸ“ ì˜ì–´ í•™ìŠµ ì•± - ì‹¤ì‹œê°„ í…ŒìŠ¤íŠ¸</h1>
    
    <!-- ì—°ê²° ìƒíƒœ -->
    <div class="section">
        <h3>ğŸ”Œ ì—°ê²° ìƒíƒœ</h3>
        <div id="connectionStatus" class="status disconnected">ì—°ê²°ë˜ì§€ ì•ŠìŒ</div>
        <button id="connectBtn" onclick="connect()">ì—°ê²°í•˜ê¸°</button>
        <button id="disconnectBtn" onclick="disconnect()" disabled>ì—°ê²° ëŠê¸°</button>
    </div>

    <!-- ì‚¬ìš©ì ì¸ì¦ -->
    <div class="section">
        <h3>ğŸ” ì‚¬ìš©ì ì¸ì¦</h3>
        <input type="text" id="userId" placeholder="ì‚¬ìš©ì ID" value="test-web-user">
        <button id="authBtn" onclick="authenticate()" disabled>ì¸ì¦í•˜ê¸°</button>
        <div id="authStatus"></div>
    </div>

    <!-- ì„¸ì…˜ ì°¸ì—¬ -->
    <div class="section">
        <h3>ğŸ¯ ì„¸ì…˜ ì°¸ì—¬</h3>
        <input type="text" id="sessionId" placeholder="ì„¸ì…˜ ID" value="web-test-session">
        <select id="situationId">
            <option value="daegu_taxi">ëŒ€êµ¬ íƒì‹œ ì´ìš©</option>
            <option value="daegu_food">ëŒ€êµ¬ ìŒì‹ì </option>
            <option value="coffee_order">ì¹´í˜ ì£¼ë¬¸</option>
        </select>
        <button id="joinBtn" onclick="joinSession()" disabled>ì„¸ì…˜ ì°¸ì—¬</button>
        <div id="sessionStatus"></div>
    </div>

    <!-- ë©”ì‹œì§€ ì „ì†¡ -->
    <div class="section">
        <h3>ğŸ’¬ ë©”ì‹œì§€ í…ŒìŠ¤íŠ¸</h3>
        <textarea id="messageInput" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." rows="3">Hello, could you take me to Suseong Lake please?</textarea>
        <button id="sendBtn" onclick="sendMessage()" disabled>ë©”ì‹œì§€ ì „ì†¡</button>
        <div id="messageStatus"></div>
    </div>

    <!-- ìŒì„± í…ŒìŠ¤íŠ¸ -->
    <div class="section">
        <h3>ğŸ¤ ìŒì„± í…ŒìŠ¤íŠ¸</h3>
        <button id="voiceBtn" onclick="sendVoice()" disabled>Mock ìŒì„± ì „ì†¡</button>
        <div id="voiceStatus"></div>
    </div>

    <!-- ì‹¤ì‹œê°„ ë¡œê·¸ -->
    <div class="section">
        <h3>ğŸ“ ì‹¤ì‹œê°„ ë¡œê·¸</h3>
        <div id="log" class="log"></div>
        <button onclick="clearLog()">ë¡œê·¸ ì§€ìš°ê¸°</button>
    </div>

    <script>
        let socket = null;
        let isAuthenticated = false;
        let isInSession = false;

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : '';
            logDiv.innerHTML += `<div class="message ${className}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function updateUI() {
            document.getElementById('connectBtn').disabled = socket && socket.connected;
            document.getElementById('disconnectBtn').disabled = !socket || !socket.connected;
            document.getElementById('authBtn').disabled = !socket || !socket.connected || isAuthenticated;
            document.getElementById('joinBtn').disabled = !isAuthenticated || isInSession;
            document.getElementById('sendBtn').disabled = !isInSession;
            document.getElementById('voiceBtn').disabled = !isInSession;
        }

        function connect() {
            try {
                socket = io('http://localhost:3000');
                
                socket.on('connect', () => {
                    document.getElementById('connectionStatus').textContent = 'ì—°ê²°ë¨';
                    document.getElementById('connectionStatus').className = 'status connected';
                    log('âœ… Socket.io ì„œë²„ì— ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
                    updateUI();
                });

                socket.on('disconnect', () => {
                    document.getElementById('connectionStatus').textContent = 'ì—°ê²° ëŠì–´ì§';
                    document.getElementById('connectionStatus').className = 'status disconnected';
                    log('âŒ ì„œë²„ì™€ì˜ ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤', 'error');
                    isAuthenticated = false;
                    isInSession = false;
                    updateUI();
                });

                socket.on('authenticated', (data) => {
                    isAuthenticated = true;
                    document.getElementById('authStatus').innerHTML = '<div class="message success">âœ… ì¸ì¦ ì„±ê³µ: ' + JSON.stringify(data) + '</div>';
                    log('âœ… ì‚¬ìš©ì ì¸ì¦ ì™„ë£Œ', 'success');
                    updateUI();
                });

                socket.on('auth-error', (error) => {
                    document.getElementById('authStatus').innerHTML = '<div class="message error">âŒ ì¸ì¦ ì‹¤íŒ¨: ' + JSON.stringify(error) + '</div>';
                    log('âŒ ì¸ì¦ ì‹¤íŒ¨: ' + error.message, 'error');
                });

                socket.on('conversation-joined', (data) => {
                    isInSession = true;
                    document.getElementById('sessionStatus').innerHTML = '<div class="message success">âœ… ì„¸ì…˜ ì°¸ì—¬ ì„±ê³µ: ' + JSON.stringify(data) + '</div>';
                    log('âœ… ì„¸ì…˜ì— ì°¸ì—¬í–ˆìŠµë‹ˆë‹¤: ' + data.sessionId, 'success');
                    updateUI();
                });

                socket.on('message-sent', (data) => {
                    document.getElementById('messageStatus').innerHTML = '<div class="message success">âœ… ë©”ì‹œì§€ ì „ì†¡ë¨: ' + JSON.stringify(data) + '</div>';
                    log('ğŸ’¬ ë©”ì‹œì§€ ì „ì†¡ ì™„ë£Œ: ' + data.content, 'success');
                });

                socket.on('voice-processed', (data) => {
                    document.getElementById('voiceStatus').innerHTML = '<div class="message success">âœ… ìŒì„± ì²˜ë¦¬ ì™„ë£Œ: ' + JSON.stringify(data) + '</div>';
                    log('ğŸ¤ ìŒì„± ì²˜ë¦¬ ì™„ë£Œ: ' + data.transcription, 'success');
                });

                socket.on('session-ended', (data) => {
                    isInSession = false;
                    log('ğŸ ì„¸ì…˜ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤: ' + JSON.stringify(data), 'success');
                    updateUI();
                });

                socket.on('error', (error) => {
                    log('âŒ ì˜¤ë¥˜: ' + JSON.stringify(error), 'error');
                });

                socket.on('voice-error', (error) => {
                    log('âŒ ìŒì„± ì˜¤ë¥˜: ' + JSON.stringify(error), 'error');
                });

            } catch (error) {
                log('âŒ ì—°ê²° ì¤‘ ì˜¤ë¥˜: ' + error.message, 'error');
            }
        }

        function disconnect() {
            if (socket) {
                socket.disconnect();
                socket = null;
                isAuthenticated = false;
                isInSession = false;
                updateUI();
                log('ğŸ”Œ ì—°ê²°ì„ ëŠì—ˆìŠµë‹ˆë‹¤');
            }
        }

        function authenticate() {
            const userId = document.getElementById('userId').value;
            if (socket && userId) {
                socket.emit('authenticate', { userId: userId });
                log('ğŸ” ì¸ì¦ ìš”ì²­: ' + userId);
            }
        }

        function joinSession() {
            const sessionId = document.getElementById('sessionId').value;
            const situationId = document.getElementById('situationId').value;
            if (socket && sessionId && situationId) {
                socket.emit('join-conversation', { sessionId, situationId });
                log('ğŸ¯ ì„¸ì…˜ ì°¸ì—¬ ìš”ì²­: ' + sessionId + ' (' + situationId + ')');
            }
        }

        function sendMessage() {
            const message = document.getElementById('messageInput').value;
            if (socket && message) {
                socket.emit('send-message', { message, sessionId: document.getElementById('sessionId').value });
                log('ğŸ’¬ ë©”ì‹œì§€ ì „ì†¡: ' + message);
            }
        }

        function sendVoice() {
            // Mock ìŒì„± ë°ì´í„°
            const mockAudioData = 'data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQAAAAA=';
            if (socket) {
                socket.emit('send-voice', { 
                    audioData: mockAudioData, 
                    duration: 2500,
                    sessionId: document.getElementById('sessionId').value
                });
                log('ğŸ¤ Mock ìŒì„± ë°ì´í„° ì „ì†¡');
            }
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        // ì´ˆê¸° UI ì„¤ì •
        updateUI();
    </script>
</body>
</html>