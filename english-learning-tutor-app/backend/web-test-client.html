<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>영어 학습 앱 - 웹 테스트 클라이언트</title>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .section { border: 1px solid #ddd; margin: 10px 0; padding: 15px; border-radius: 5px; }
        .section h3 { margin-top: 0; color: #333; }
        .status { padding: 5px 10px; border-radius: 3px; font-weight: bold; }
        .connected { background: #d4edda; color: #155724; }
        .disconnected { background: #f8d7da; color: #721c24; }
        .message { margin: 5px 0; padding: 8px; background: #f8f9fa; border-left: 4px solid #007bff; }
        .error { border-left-color: #dc3545; background: #f8d7da; }
        .success { border-left-color: #28a745; background: #d4edda; }
        button { background: #007bff; color: white; border: none; padding: 10px 15px; margin: 5px; border-radius: 3px; cursor: pointer; }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        input, textarea { width: 100%; padding: 8px; margin: 5px 0; border: 1px solid #ddd; border-radius: 3px; }
        .log { background: #f8f9fa; border: 1px solid #ddd; padding: 10px; height: 200px; overflow-y: auto; font-family: monospace; font-size: 12px; }
    </style>
</head>
<body>
    <h1>🎓 영어 학습 앱 - 실시간 테스트</h1>
    
    <!-- 연결 상태 -->
    <div class="section">
        <h3>🔌 연결 상태</h3>
        <div id="connectionStatus" class="status disconnected">연결되지 않음</div>
        <button id="connectBtn" onclick="connect()">연결하기</button>
        <button id="disconnectBtn" onclick="disconnect()" disabled>연결 끊기</button>
    </div>

    <!-- 사용자 인증 -->
    <div class="section">
        <h3>🔐 사용자 인증</h3>
        <input type="text" id="userId" placeholder="사용자 ID" value="test-web-user">
        <button id="authBtn" onclick="authenticate()" disabled>인증하기</button>
        <div id="authStatus"></div>
    </div>

    <!-- 세션 참여 -->
    <div class="section">
        <h3>🎯 세션 참여</h3>
        <input type="text" id="sessionId" placeholder="세션 ID" value="web-test-session">
        <select id="situationId">
            <option value="daegu_taxi">대구 택시 이용</option>
            <option value="daegu_food">대구 음식점</option>
            <option value="coffee_order">카페 주문</option>
        </select>
        <button id="joinBtn" onclick="joinSession()" disabled>세션 참여</button>
        <div id="sessionStatus"></div>
    </div>

    <!-- 메시지 전송 -->
    <div class="section">
        <h3>💬 메시지 테스트</h3>
        <textarea id="messageInput" placeholder="메시지를 입력하세요..." rows="3">Hello, could you take me to Suseong Lake please?</textarea>
        <button id="sendBtn" onclick="sendMessage()" disabled>메시지 전송</button>
        <div id="messageStatus"></div>
    </div>

    <!-- 음성 테스트 -->
    <div class="section">
        <h3>🎤 음성 테스트</h3>
        <button id="voiceBtn" onclick="sendVoice()" disabled>Mock 음성 전송</button>
        <div id="voiceStatus"></div>
    </div>

    <!-- 실시간 로그 -->
    <div class="section">
        <h3>📝 실시간 로그</h3>
        <div id="log" class="log"></div>
        <button onclick="clearLog()">로그 지우기</button>
    </div>

    <script>
        let socket = null;
        let isAuthenticated = false;
        let isInSession = false;

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : '';
            logDiv.innerHTML += `<div class="message ${className}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function updateUI() {
            document.getElementById('connectBtn').disabled = socket && socket.connected;
            document.getElementById('disconnectBtn').disabled = !socket || !socket.connected;
            document.getElementById('authBtn').disabled = !socket || !socket.connected || isAuthenticated;
            document.getElementById('joinBtn').disabled = !isAuthenticated || isInSession;
            document.getElementById('sendBtn').disabled = !isInSession;
            document.getElementById('voiceBtn').disabled = !isInSession;
        }

        function connect() {
            try {
                socket = io('http://localhost:3000');
                
                socket.on('connect', () => {
                    document.getElementById('connectionStatus').textContent = '연결됨';
                    document.getElementById('connectionStatus').className = 'status connected';
                    log('✅ Socket.io 서버에 연결되었습니다', 'success');
                    updateUI();
                });

                socket.on('disconnect', () => {
                    document.getElementById('connectionStatus').textContent = '연결 끊어짐';
                    document.getElementById('connectionStatus').className = 'status disconnected';
                    log('❌ 서버와의 연결이 끊어졌습니다', 'error');
                    isAuthenticated = false;
                    isInSession = false;
                    updateUI();
                });

                socket.on('authenticated', (data) => {
                    isAuthenticated = true;
                    document.getElementById('authStatus').innerHTML = '<div class="message success">✅ 인증 성공: ' + JSON.stringify(data) + '</div>';
                    log('✅ 사용자 인증 완료', 'success');
                    updateUI();
                });

                socket.on('auth-error', (error) => {
                    document.getElementById('authStatus').innerHTML = '<div class="message error">❌ 인증 실패: ' + JSON.stringify(error) + '</div>';
                    log('❌ 인증 실패: ' + error.message, 'error');
                });

                socket.on('conversation-joined', (data) => {
                    isInSession = true;
                    document.getElementById('sessionStatus').innerHTML = '<div class="message success">✅ 세션 참여 성공: ' + JSON.stringify(data) + '</div>';
                    log('✅ 세션에 참여했습니다: ' + data.sessionId, 'success');
                    updateUI();
                });

                socket.on('message-sent', (data) => {
                    document.getElementById('messageStatus').innerHTML = '<div class="message success">✅ 메시지 전송됨: ' + JSON.stringify(data) + '</div>';
                    log('💬 메시지 전송 완료: ' + data.content, 'success');
                });

                socket.on('voice-processed', (data) => {
                    document.getElementById('voiceStatus').innerHTML = '<div class="message success">✅ 음성 처리 완료: ' + JSON.stringify(data) + '</div>';
                    log('🎤 음성 처리 완료: ' + data.transcription, 'success');
                });

                socket.on('session-ended', (data) => {
                    isInSession = false;
                    log('🏁 세션이 종료되었습니다: ' + JSON.stringify(data), 'success');
                    updateUI();
                });

                socket.on('error', (error) => {
                    log('❌ 오류: ' + JSON.stringify(error), 'error');
                });

                socket.on('voice-error', (error) => {
                    log('❌ 음성 오류: ' + JSON.stringify(error), 'error');
                });

            } catch (error) {
                log('❌ 연결 중 오류: ' + error.message, 'error');
            }
        }

        function disconnect() {
            if (socket) {
                socket.disconnect();
                socket = null;
                isAuthenticated = false;
                isInSession = false;
                updateUI();
                log('🔌 연결을 끊었습니다');
            }
        }

        function authenticate() {
            const userId = document.getElementById('userId').value;
            if (socket && userId) {
                socket.emit('authenticate', { userId: userId });
                log('🔐 인증 요청: ' + userId);
            }
        }

        function joinSession() {
            const sessionId = document.getElementById('sessionId').value;
            const situationId = document.getElementById('situationId').value;
            if (socket && sessionId && situationId) {
                socket.emit('join-conversation', { sessionId, situationId });
                log('🎯 세션 참여 요청: ' + sessionId + ' (' + situationId + ')');
            }
        }

        function sendMessage() {
            const message = document.getElementById('messageInput').value;
            if (socket && message) {
                socket.emit('send-message', { message, sessionId: document.getElementById('sessionId').value });
                log('💬 메시지 전송: ' + message);
            }
        }

        function sendVoice() {
            // Mock 음성 데이터
            const mockAudioData = 'data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQAAAAA=';
            if (socket) {
                socket.emit('send-voice', { 
                    audioData: mockAudioData, 
                    duration: 2500,
                    sessionId: document.getElementById('sessionId').value
                });
                log('🎤 Mock 음성 데이터 전송');
            }
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        // 초기 UI 설정
        updateUI();
    </script>
</body>
</html>